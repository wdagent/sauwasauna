---
/**
 * GiftRedemptionFlow - Gift Redemption Widget
 * WDA-1033: Complete flow for redeeming purchased gifts
 *
 * Flow:
 * 1. Enter and validate gift code
 * 2. Select date and time slot
 * 3. Enter attendee details (N attendees based on includedPersons)
 * 4. Show confirmation with ticket download
 *
 * Key difference from VoucherRedemptionFlow:
 * - GIFT: 1 code for N persons (must enter N attendees)
 * - VOUCHER: N codes for N persons (1 attendee per code)
 *
 * Pattern: Client-side state management with multi-step form
 */

import { getLegalUrl } from '../../lib/wordpress/legal-slugs.js';

export interface Props {
  locale?: 'es' | 'ca' | 'en' | 'fr';
  class?: string;
}

const { locale = 'es', class: className = '' } = Astro.props;

// Translations for all supported languages
const translations = {
  es: {
    pageTitle: 'Canjear tu regalo',
    // Step 1: Code Entry
    step1Title: 'Introduce tu código',
    codeLabel: 'Código del regalo',
    codePlaceholder: 'GIFT-2025-XXXXXX-XXXX',
    validateButton: 'Validar código',
    validating: 'Validando...',
    // Step 2: Validated - Date/Time Selection
    step2Title: 'Código válido',
    validCode: '¡Código válido!',
    sessionLabel: 'Sesión',
    validUntil: 'Válido hasta',
    includedPersons: 'Incluye entrada para {n} personas',
    selectDateTime: 'Selecciona fecha y hora',
    changeDate: 'Cambiar fecha',
    prevMonth: 'Mes anterior',
    nextMonth: 'Mes siguiente',
    months: ['Enero', 'Febrero', 'Marzo', 'Abril', 'Mayo', 'Junio', 'Julio', 'Agosto', 'Septiembre', 'Octubre', 'Noviembre', 'Diciembre'],
    weekdays: ['Lun', 'Mar', 'Mié', 'Jue', 'Vie', 'Sáb', 'Dom'],
    // Step 3: Attendees Form
    step3Title: 'Datos de los asistentes',
    attendeesDetails: 'Introduce los datos de los {n} asistentes',
    attendeeLabel: 'Asistente {n}',
    nameLabel: 'Nombre completo',
    emailLabel: 'Correo electrónico',
    dniLabel: 'DNI/NIE (opcional)',
    privacyLabel: 'Acepto la',
    privacyLink: 'política de privacidad',
    privacyUrl: getLegalUrl('POLITICA_PRIVACIDAD', 'es'),
    termsLabel: 'Acepto las',
    termsLink: 'condiciones de contratación',
    termsUrl: getLegalUrl('CONDICIONES_CONTRATACION', 'es'),
    confirmButton: 'Confirmar reserva',
    changeSlot: 'Cambiar horario',
    confirming: 'Procesando...',
    // Step 4: Confirmation
    step4Title: 'Reserva confirmada',
    successTitle: '¡Reserva confirmada!',
    yourTicket: 'Tu entrada para',
    downloadPdf: 'Descargar ticket PDF',
    addCalendar: 'Añadir al calendario',
    bookingNumber: 'Número de reserva',
    bookingDate: 'Fecha',
    bookingTime: 'Hora',
    bookingAttendees: 'Asistentes',
    newRedemption: 'Canjear otro regalo',
    // Errors
    errorInvalid: 'El código introducido no es válido',
    errorRedeemed: 'Este código ya ha sido canjeado el {date}',
    errorExpired: 'Este código expiró el {date}',
    errorNoSlots: 'No hay disponibilidad para la fecha seleccionada',
    errorGeneric: 'Ha ocurrido un error. Por favor, inténtalo de nuevo.',
    errorNotDelivered: 'Este regalo aún no ha sido entregado',
    // Validation
    nameRequired: 'El nombre es obligatorio',
    emailRequired: 'El email es obligatorio',
    emailInvalid: 'El email no es válido',
    privacyRequired: 'Debes aceptar la política de privacidad',
    termsRequired: 'Debes aceptar las condiciones de contratación',
    allAttendeesRequired: 'Debes completar los datos de todos los asistentes',
    // Loading
    loadingDates: 'Cargando fechas disponibles...',
    loadingSlots: 'Cargando horarios...',
    noSlots: 'No hay horarios disponibles para esta fecha',
    noDates: 'No hay fechas disponibles',
    // Slots
    available: 'disponibles',
    spots: 'plazas',
    full: 'Completo',
  },
  ca: {
    pageTitle: 'Bescanviar el teu regal',
    step1Title: 'Introdueix el teu codi',
    codeLabel: 'Codi del regal',
    codePlaceholder: 'GIFT-2025-XXXXXX-XXXX',
    validateButton: 'Validar codi',
    validating: 'Validant...',
    step2Title: 'Codi vàlid',
    validCode: 'Codi vàlid!',
    sessionLabel: 'Sessió',
    validUntil: 'Vàlid fins',
    includedPersons: 'Inclou entrada per a {n} persones',
    selectDateTime: 'Selecciona data i hora',
    changeDate: 'Canviar data',
    prevMonth: 'Mes anterior',
    nextMonth: 'Mes següent',
    months: ['Gener', 'Febrer', 'Març', 'Abril', 'Maig', 'Juny', 'Juliol', 'Agost', 'Setembre', 'Octubre', 'Novembre', 'Desembre'],
    weekdays: ['Dll', 'Dmt', 'Dmc', 'Dij', 'Dve', 'Dis', 'Dge'],
    step3Title: 'Dades dels assistents',
    attendeesDetails: 'Introdueix les dades dels {n} assistents',
    attendeeLabel: 'Assistent {n}',
    nameLabel: 'Nom complet',
    emailLabel: 'Correu electrònic',
    dniLabel: 'DNI/NIE (opcional)',
    privacyLabel: 'Accepto la',
    privacyLink: 'política de privacitat',
    privacyUrl: getLegalUrl('POLITICA_PRIVACIDAD', 'ca'),
    termsLabel: 'Accepto les',
    termsLink: 'condicions de contractació',
    termsUrl: getLegalUrl('CONDICIONES_CONTRATACION', 'ca'),
    confirmButton: 'Confirmar reserva',
    changeSlot: 'Canviar horari',
    confirming: 'Processant...',
    step4Title: 'Reserva confirmada',
    successTitle: 'Reserva confirmada!',
    yourTicket: 'La teva entrada per',
    downloadPdf: 'Descarregar ticket PDF',
    addCalendar: 'Afegir al calendari',
    bookingNumber: 'Número de reserva',
    bookingDate: 'Data',
    bookingTime: 'Hora',
    bookingAttendees: 'Assistents',
    newRedemption: 'Bescanviar un altre regal',
    errorInvalid: 'El codi introduït no és vàlid',
    errorRedeemed: 'Aquest codi ja ha estat bescanviat el {date}',
    errorExpired: 'Aquest codi va expirar el {date}',
    errorNoSlots: 'No hi ha disponibilitat per la data seleccionada',
    errorGeneric: 'S\'ha produït un error. Si us plau, torna-ho a intentar.',
    errorNotDelivered: 'Aquest regal encara no ha estat entregat',
    nameRequired: 'El nom és obligatori',
    emailRequired: 'L\'email és obligatori',
    emailInvalid: 'L\'email no és vàlid',
    privacyRequired: 'Has d\'acceptar la política de privacitat',
    termsRequired: 'Has d\'acceptar les condicions de contractació',
    allAttendeesRequired: 'Has de completar les dades de tots els assistents',
    loadingDates: 'Carregant dates disponibles...',
    loadingSlots: 'Carregant horaris...',
    noSlots: 'No hi ha horaris disponibles per aquesta data',
    noDates: 'No hi ha dates disponibles',
    available: 'disponibles',
    spots: 'places',
    full: 'Complet',
  },
  en: {
    pageTitle: 'Redeem your gift',
    step1Title: 'Enter your code',
    codeLabel: 'Gift code',
    codePlaceholder: 'GIFT-2025-XXXXXX-XXXX',
    validateButton: 'Validate code',
    validating: 'Validating...',
    step2Title: 'Valid code',
    validCode: 'Valid code!',
    sessionLabel: 'Session',
    validUntil: 'Valid until',
    includedPersons: 'Includes entry for {n} people',
    selectDateTime: 'Select date and time',
    changeDate: 'Change date',
    prevMonth: 'Previous month',
    nextMonth: 'Next month',
    months: ['January', 'February', 'March', 'April', 'May', 'June', 'July', 'August', 'September', 'October', 'November', 'December'],
    weekdays: ['Mon', 'Tue', 'Wed', 'Thu', 'Fri', 'Sat', 'Sun'],
    step3Title: 'Attendee details',
    attendeesDetails: 'Enter details for all {n} attendees',
    attendeeLabel: 'Attendee {n}',
    nameLabel: 'Full name',
    emailLabel: 'Email address',
    dniLabel: 'ID number (optional)',
    privacyLabel: 'I accept the',
    privacyLink: 'privacy policy',
    privacyUrl: getLegalUrl('POLITICA_PRIVACIDAD', 'en'),
    termsLabel: 'I accept the',
    termsLink: 'terms and conditions',
    termsUrl: getLegalUrl('CONDICIONES_CONTRATACION', 'en'),
    confirmButton: 'Confirm booking',
    changeSlot: 'Change time',
    confirming: 'Processing...',
    step4Title: 'Booking confirmed',
    successTitle: 'Booking confirmed!',
    yourTicket: 'Your ticket for',
    downloadPdf: 'Download PDF ticket',
    addCalendar: 'Add to calendar',
    bookingNumber: 'Booking number',
    bookingDate: 'Date',
    bookingTime: 'Time',
    bookingAttendees: 'Attendees',
    newRedemption: 'Redeem another gift',
    errorInvalid: 'The code entered is not valid',
    errorRedeemed: 'This code was already redeemed on {date}',
    errorExpired: 'This code expired on {date}',
    errorNoSlots: 'No availability for the selected date',
    errorGeneric: 'An error occurred. Please try again.',
    errorNotDelivered: 'This gift has not been delivered yet',
    nameRequired: 'Name is required',
    emailRequired: 'Email is required',
    emailInvalid: 'Email is not valid',
    privacyRequired: 'You must accept the privacy policy',
    termsRequired: 'You must accept the terms and conditions',
    allAttendeesRequired: 'You must complete details for all attendees',
    loadingDates: 'Loading available dates...',
    loadingSlots: 'Loading time slots...',
    noSlots: 'No time slots available for this date',
    noDates: 'No dates available',
    available: 'available',
    spots: 'spots',
    full: 'Full',
  },
  fr: {
    pageTitle: 'Échanger votre cadeau',
    step1Title: 'Entrez votre code',
    codeLabel: 'Code du cadeau',
    codePlaceholder: 'GIFT-2025-XXXXXX-XXXX',
    validateButton: 'Valider le code',
    validating: 'Validation...',
    step2Title: 'Code valide',
    validCode: 'Code valide !',
    sessionLabel: 'Session',
    validUntil: 'Valable jusqu\'au',
    includedPersons: 'Inclut l\'entrée pour {n} personnes',
    selectDateTime: 'Sélectionnez date et heure',
    changeDate: 'Changer la date',
    prevMonth: 'Mois précédent',
    nextMonth: 'Mois suivant',
    months: ['Janvier', 'Février', 'Mars', 'Avril', 'Mai', 'Juin', 'Juillet', 'Août', 'Septembre', 'Octobre', 'Novembre', 'Décembre'],
    weekdays: ['Lun', 'Mar', 'Mer', 'Jeu', 'Ven', 'Sam', 'Dim'],
    step3Title: 'Détails des participants',
    attendeesDetails: 'Entrez les détails des {n} participants',
    attendeeLabel: 'Participant {n}',
    nameLabel: 'Nom complet',
    emailLabel: 'Adresse e-mail',
    dniLabel: 'Numéro d\'identification (facultatif)',
    privacyLabel: 'J\'accepte la',
    privacyLink: 'politique de confidentialité',
    privacyUrl: getLegalUrl('POLITICA_PRIVACIDAD', 'fr'),
    termsLabel: 'J\'accepte les',
    termsLink: 'conditions de service',
    termsUrl: getLegalUrl('CONDICIONES_CONTRATACION', 'fr'),
    confirmButton: 'Confirmer la réservation',
    changeSlot: 'Changer l\'heure',
    confirming: 'Traitement...',
    step4Title: 'Réservation confirmée',
    successTitle: 'Réservation confirmée !',
    yourTicket: 'Votre billet pour',
    downloadPdf: 'Télécharger le billet PDF',
    addCalendar: 'Ajouter au calendrier',
    bookingNumber: 'Numéro de réservation',
    bookingDate: 'Date',
    bookingTime: 'Heure',
    bookingAttendees: 'Participants',
    newRedemption: 'Échanger un autre cadeau',
    errorInvalid: 'Le code saisi n\'est pas valide',
    errorRedeemed: 'Ce code a déjà été échangé le {date}',
    errorExpired: 'Ce code a expiré le {date}',
    errorNoSlots: 'Aucune disponibilité pour la date sélectionnée',
    errorGeneric: 'Une erreur s\'est produite. Veuillez réessayer.',
    errorNotDelivered: 'Ce cadeau n\'a pas encore été livré',
    nameRequired: 'Le nom est obligatoire',
    emailRequired: 'L\'e-mail est obligatoire',
    emailInvalid: 'L\'e-mail n\'est pas valide',
    privacyRequired: 'Vous devez accepter la politique de confidentialité',
    termsRequired: 'Vous devez accepter les conditions de service',
    allAttendeesRequired: 'Vous devez compléter les détails de tous les participants',
    loadingDates: 'Chargement des dates disponibles...',
    loadingSlots: 'Chargement des créneaux horaires...',
    noSlots: 'Aucun créneau horaire disponible pour cette date',
    noDates: 'Aucune date disponible',
    available: 'disponibles',
    spots: 'places',
    full: 'Complet',
  },
};

const t = translations[locale];
---

<div class={`gift-redemption ${className}`} data-locale={locale} data-translations={JSON.stringify(t)}>
  <!-- Step Indicator -->
  <div class="steps-indicator">
    <div class="step" data-step="1" data-active="true">
      <div class="step-number">1</div>
      <div class="step-label">{t.step1Title}</div>
    </div>
    <div class="step" data-step="2">
      <div class="step-number">2</div>
      <div class="step-label">{t.step2Title}</div>
    </div>
    <div class="step" data-step="3">
      <div class="step-number">3</div>
      <div class="step-label">{t.step3Title}</div>
    </div>
    <div class="step" data-step="4">
      <div class="step-number">4</div>
      <div class="step-label">{t.step4Title}</div>
    </div>
  </div>

  <!-- Step 1: Code Entry -->
  <div class="step-content" data-step-content="1" data-active="true">
    <div class="card">
      <h2 class="step-title">{t.step1Title}</h2>
      <form id="code-form" class="code-form">
        <div class="form-group">
          <label for="gift-code" class="form-label">{t.codeLabel}</label>
          <input
            type="text"
            id="gift-code"
            class="form-input"
            placeholder={t.codePlaceholder}
            pattern="GIFT-\d{4}-[A-Z0-9]{6}-[A-Z0-9]{4}"
            required
          />
        </div>
        <div class="error-message" id="code-error" role="alert"></div>
        <button type="submit" class="btn btn-primary" id="validate-btn">
          <span class="btn-text">{t.validateButton}</span>
          <span class="btn-loading hidden">{t.validating}</span>
        </button>
      </form>
    </div>
  </div>

  <!-- Step 2: Date/Time Selection -->
  <div class="step-content" data-step-content="2">
    <div class="card">
      <div class="gift-info" id="gift-info"></div>
      <h2 class="step-title">{t.selectDateTime}</h2>
      <div id="calendar-container" class="calendar-container"></div>
      <div id="slots-container" class="slots-container hidden"></div>
      <div class="error-message" id="date-error" role="alert"></div>
    </div>
  </div>

  <!-- Step 3: Attendees Form -->
  <div class="step-content" data-step-content="3">
    <div class="card">
      <h2 class="step-title" id="attendees-title">{t.step3Title}</h2>
      <div class="booking-summary" id="booking-summary"></div>
      <p class="attendees-description" id="attendees-description"></p>
      <form id="attendees-form" class="attendees-form">
        <div id="attendees-list" class="attendees-list">
          <!-- Attendee forms will be dynamically generated here -->
        </div>
        <div class="form-group">
          <label class="checkbox-label">
            <input type="checkbox" id="privacy-consent" required />
            <span>
              {t.privacyLabel}
              <a href={t.privacyUrl} target="_blank" rel="noopener">{t.privacyLink}</a>
            </span>
          </label>
        </div>
        <div class="form-group">
          <label class="checkbox-label">
            <input type="checkbox" id="terms-consent" required />
            <span>
              {t.termsLabel}
              <a href={t.termsUrl} target="_blank" rel="noopener">{t.termsLink}</a>
            </span>
          </label>
        </div>
        <div class="error-message" id="form-error" role="alert"></div>
        <div class="button-group">
          <button type="button" class="btn btn-secondary" id="back-to-slots">
            {t.changeSlot}
          </button>
          <button type="submit" class="btn btn-primary" id="confirm-btn">
            <span class="btn-text">{t.confirmButton}</span>
            <span class="btn-loading hidden">{t.confirming}</span>
          </button>
        </div>
      </form>
    </div>
  </div>

  <!-- Step 4: Confirmation -->
  <div class="step-content" data-step-content="4">
    <div class="card confirmation-card">
      <div class="success-icon">
        <svg width="64" height="64" viewBox="0 0 64 64" fill="none">
          <circle cx="32" cy="32" r="32" fill="#10B981" opacity="0.1"/>
          <path d="M20 32L28 40L44 24" stroke="#10B981" stroke-width="4" stroke-linecap="round" stroke-linejoin="round"/>
        </svg>
      </div>
      <h2 class="success-title">{t.successTitle}</h2>
      <div id="confirmation-details" class="confirmation-details"></div>
      <div class="action-buttons">
        <button type="button" class="btn btn-primary" id="download-ticket">
          {t.downloadPdf}
        </button>
        <button type="button" class="btn btn-secondary" id="add-calendar">
          {t.addCalendar}
        </button>
      </div>
      <button type="button" class="btn btn-link" id="new-redemption">
        {t.newRedemption}
      </button>
    </div>
  </div>
</div>

<style>
  /* ==============================================
     WDA-1033-UX: SAUWA Design System Colors
     Using BookingWidget color palette
     ============================================== */

  /* Container */
  .gift-redemption {
    --gift-primary: #DB4529;
    --gift-primary-hover: #BA2515;
    --gift-success: #10b981;
    --gift-error: #ef4444;
    --gift-gray-50: #f9fafb;
    --gift-gray-100: #f3f4f6;
    --gift-gray-200: #e5e7eb;
    --gift-gray-300: #d1d5db;
    --gift-gray-400: #9ca3af;
    --gift-gray-500: #6b7280;
    --gift-gray-600: #4b5563;
    --gift-gray-700: #374151;
    --gift-gray-800: #1f2937;
    --gift-gray-900: #111827;

    font-family: 'Avenir Next', 'Nunito Sans', sans-serif;
    max-width: 800px;
    margin: 0 auto;
    padding: 2rem 1rem;
  }

  /* Steps Indicator - Matches BookingWidget */
  .steps-indicator {
    display: flex;
    justify-content: space-between;
    margin-bottom: 3rem;
    padding-bottom: 1.5rem;
    border-bottom: 1px solid var(--gift-gray-200);
    position: relative;
  }

  .steps-indicator::before {
    content: '';
    position: absolute;
    top: 16px;
    left: 10%;
    right: 10%;
    height: 2px;
    background: var(--gift-gray-200);
    z-index: 0;
  }

  .step {
    display: flex;
    flex-direction: column;
    align-items: center;
    gap: 0.5rem;
    flex: 1;
    position: relative;
    z-index: 1;
    opacity: 0.4;
    transition: opacity 0.3s ease;
  }

  .step[data-active="true"] {
    opacity: 1;
  }

  .step-number {
    width: 32px;
    height: 32px;
    border-radius: 50%;
    background: var(--gift-gray-200);
    color: var(--gift-gray-600);
    display: flex;
    align-items: center;
    justify-content: center;
    font-size: 0.875rem;
    font-weight: 600;
    transition: all 0.3s ease;
  }

  .step[data-active="true"] .step-number {
    background: var(--gift-primary);
    color: white;
  }

  .step-label {
    font-size: 0.75rem;
    font-weight: 500;
    color: var(--gift-gray-600);
    text-align: center;
    max-width: 80px;
    min-height: 32px;
    line-height: 1.3;
    transition: color 0.3s ease;
  }

  .step[data-active="true"] .step-label {
    color: var(--gift-gray-900);
    font-weight: 600;
  }

  /* Step Content */
  .step-content {
    display: none;
  }

  .step-content[data-active="true"] {
    display: block;
    animation: fadeIn 0.4s ease;
  }

  @keyframes fadeIn {
    from { opacity: 0; transform: translateY(10px); }
    to { opacity: 1; transform: translateY(0); }
  }

  /* Card */
  .card {
    background: white;
    border-radius: 16px;
    padding: 2.5rem;
    box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1), 0 2px 4px -1px rgba(0, 0, 0, 0.06);
  }

  .step-title {
    font-size: 1.5rem;
    font-weight: 700;
    color: #1F2937;
    margin-bottom: 1.5rem;
  }

  /* Form Elements */
  .form-group {
    margin-bottom: 1.5rem;
  }

  .form-label {
    display: block;
    font-size: 0.875rem;
    font-weight: 600;
    color: #374151;
    margin-bottom: 0.5rem;
  }

  .form-input {
    width: 100%;
    padding: 0.875rem 1rem;
    background: white;
    border: 1px solid #d1d5db;
    border-radius: 8px;
    font-size: 1rem;
    color: #1f2937;
    transition: all 0.2s ease;
  }

  .form-input::placeholder {
    color: #9ca3af;
  }

  .form-input:focus {
    outline: none;
    border-color: var(--gift-primary);
    box-shadow: 0 0 0 3px rgba(219, 69, 41, 0.15);
  }

  .checkbox-label {
    display: flex;
    align-items: flex-start;
    gap: 0.75rem;
    cursor: pointer;
    font-size: 0.875rem;
    color: var(--gift-gray-700);
  }

  .checkbox-label input[type="checkbox"] {
    margin-top: 0.25rem;
    width: 18px;
    height: 18px;
    cursor: pointer;
    accent-color: var(--gift-primary);
  }

  .checkbox-label a {
    color: var(--gift-primary);
    text-decoration: underline;
    transition: color 0.2s ease;
  }

  .checkbox-label a:hover {
    color: var(--gift-primary-hover);
  }

  /* Buttons - Matches BookingWidget submit-button */
  .btn {
    padding: 1rem 2rem;
    border-radius: 8px;
    font-family: inherit;
    font-weight: 600;
    font-size: 1rem;
    cursor: pointer;
    transition: all 0.2s ease;
    border: none;
    display: inline-flex;
    align-items: center;
    justify-content: center;
    gap: 0.5rem;
  }

  .btn-primary {
    background: var(--gift-primary);
    color: white;
  }

  .btn-primary:hover:not(:disabled) {
    background: var(--gift-primary-hover);
    transform: translateY(-1px);
    box-shadow: 0 4px 12px rgba(219, 69, 41, 0.3);
  }

  .btn-primary:disabled {
    opacity: 0.6;
    cursor: not-allowed;
  }

  .btn-secondary {
    background: var(--gift-gray-100);
    color: var(--gift-gray-700);
    border: 1px solid var(--gift-gray-300);
  }

  .btn-secondary:hover {
    background: var(--gift-gray-200);
  }

  .btn-link {
    background: none;
    color: var(--gift-primary);
    text-decoration: underline;
  }

  .btn-link:hover {
    color: var(--gift-primary-hover);
  }

  .btn-loading {
    display: none;
  }

  .btn[disabled] .btn-text {
    display: none;
  }

  .btn[disabled] .btn-loading {
    display: inline;
  }

  .button-group {
    display: flex;
    gap: 1rem;
    margin-top: 2rem;
  }

  /* Error Messages */
  .error-message {
    color: #DC2626;
    font-size: 0.875rem;
    margin-top: 0.5rem;
    display: none;
  }

  .error-message:not(:empty) {
    display: block;
  }

  /* Hidden Utility */
  .hidden {
    display: none !important;
  }

  /* Gift Info - SAUWA orange theme */
  .gift-info {
    background: linear-gradient(135deg, #fef3ec, #fff8f5);
    border: 2px solid var(--gift-primary);
    border-radius: 12px;
    padding: 1.5rem;
    margin-bottom: 2rem;
  }

  /* Attendees Section */
  .attendees-description {
    color: #6B7280;
    margin-bottom: 1.5rem;
  }

  .attendees-list {
    display: flex;
    flex-direction: column;
    gap: 1.5rem;
    margin-bottom: 1.5rem;
  }

  .attendee-card {
    background: #F9FAFB;
    border: 1px solid #E5E7EB;
    border-radius: 12px;
    padding: 1.5rem;
  }

  .attendee-header {
    display: flex;
    align-items: center;
    gap: 0.5rem;
    margin-bottom: 1rem;
    font-weight: 600;
    color: #374151;
  }

  .attendee-number {
    width: 28px;
    height: 28px;
    border-radius: 50%;
    background: var(--gift-primary);
    color: white;
    display: flex;
    align-items: center;
    justify-content: center;
    font-size: 0.875rem;
  }

  .attendee-fields {
    display: grid;
    grid-template-columns: 1fr 1fr;
    gap: 1rem;
  }

  /* Success Icon */
  .success-icon {
    text-align: center;
    margin-bottom: 1.5rem;
  }

  .success-title {
    text-align: center;
    font-size: 2rem;
    font-weight: 700;
    color: #10B981;
    margin-bottom: 2rem;
  }

  .confirmation-details {
    background: #F9FAFB;
    border-radius: 12px;
    padding: 1.5rem;
    margin-bottom: 2rem;
  }

  .action-buttons {
    display: flex;
    gap: 1rem;
    margin-bottom: 1rem;
  }

  /* Calendar */
  .calendar-container {
    position: relative;
  }

  .calendar-header {
    display: flex;
    align-items: center;
    justify-content: space-between;
    margin-bottom: 1rem;
  }

  .calendar-nav {
    width: 36px;
    height: 36px;
    display: flex;
    align-items: center;
    justify-content: center;
    background: #F3F4F6;
    border: none;
    border-radius: 8px;
    cursor: pointer;
    transition: all 0.2s ease;
  }

  .calendar-nav:hover {
    background: #E5E7EB;
  }

  .calendar-nav:disabled {
    opacity: 0.4;
    cursor: not-allowed;
  }

  .calendar-nav svg {
    width: 20px;
    height: 20px;
    color: #374151;
  }

  .calendar-month-year {
    font-size: 1.125rem;
    font-weight: 600;
    color: #1F2937;
  }

  .calendar-weekdays {
    display: grid;
    grid-template-columns: repeat(7, 1fr);
    gap: 4px;
    margin-bottom: 0.5rem;
  }

  .weekday {
    text-align: center;
    font-size: 0.75rem;
    font-weight: 600;
    color: #6B7280;
    padding: 0.5rem 0;
  }

  .calendar-grid {
    display: grid;
    grid-template-columns: repeat(7, 1fr);
    gap: 4px;
  }

  :global(.calendar-day) {
    aspect-ratio: 1;
    display: flex;
    align-items: center;
    justify-content: center;
    font-size: 0.875rem;
    font-weight: 500;
    border: none;
    border-radius: 8px;
    cursor: pointer;
    transition: all 0.2s ease;
    background: transparent;
    color: #374151;
    min-height: 40px;
    position: relative;
  }

  :global(.calendar-day.empty) {
    cursor: default;
  }

  :global(.calendar-day.disabled) {
    color: #D1D5DB;
    cursor: not-allowed;
  }

  :global(.calendar-day.available) {
    background: rgba(219, 69, 41, 0.1) !important;
    color: #1F2937 !important;
  }

  :global(.calendar-day.available)::after {
    content: '';
    position: absolute;
    bottom: 4px;
    left: 50%;
    transform: translateX(-50%);
    width: 5px;
    height: 5px;
    border-radius: 50%;
    background: var(--gift-primary);
  }

  :global(.calendar-day.available:hover) {
    background: var(--gift-primary) !important;
    color: white !important;
  }

  :global(.calendar-day.available:hover)::after {
    background: white;
  }

  :global(.calendar-day.selected) {
    background: var(--gift-primary) !important;
    color: white !important;
  }

  :global(.calendar-day.selected)::after {
    background: white;
  }

  :global(.calendar-day.today) {
    box-shadow: inset 0 0 0 2px var(--gift-primary);
  }

  .calendar-loading {
    display: flex;
    align-items: center;
    justify-content: center;
    padding: 2rem;
    color: #6B7280;
    font-size: 0.875rem;
  }

  /* Time Slots */
  .slots-grid {
    display: grid;
    grid-template-columns: repeat(auto-fill, minmax(140px, 1fr));
    gap: 1rem;
    margin-top: 1.5rem;
  }

  .slot-btn {
    padding: 1rem;
    background: white;
    border: 2px solid #E5E7EB;
    border-radius: 10px;
    cursor: pointer;
    transition: all 0.2s ease;
    text-align: center;
  }

  .slot-btn:hover:not(:disabled) {
    border-color: var(--gift-primary);
    box-shadow: 0 2px 8px rgba(219, 69, 41, 0.15);
  }

  .slot-btn:disabled {
    opacity: 0.5;
    cursor: not-allowed;
  }

  .slot-time {
    font-size: 1.125rem;
    font-weight: 600;
    color: #1F2937;
    margin-bottom: 0.25rem;
  }

  .slot-capacity {
    font-size: 0.75rem;
    color: var(--gift-primary);
  }

  /* Responsive */
  @media (max-width: 767px) {
    .gift-redemption {
      padding: 1rem;
    }

    .card {
      padding: 1.5rem;
    }

    .steps-indicator {
      margin-bottom: 2rem;
    }

    .step-label {
      font-size: 0.75rem;
    }

    .step-number {
      width: 32px;
      height: 32px;
      font-size: 0.875rem;
    }

    .button-group,
    .action-buttons {
      flex-direction: column;
    }

    .btn {
      width: 100%;
    }

    .attendee-fields {
      grid-template-columns: 1fr;
    }
  }
</style>

<script>
  import { validateGift, redeemGift, getAvailableDates, getDaySlots, formatDate, formatTime } from '../../lib/booking/api';
  import type { TimeSlot } from '../../lib/booking/types';

  interface GiftData {
    code: string;
    baseSession: {
      id: number;
      title: string;
    };
    includedPersons: number;
    expiresAt: string;
    status: string;
  }

  // Get locale and translations from DOM
  const container = document.querySelector('.gift-redemption');
  const locale = container?.getAttribute('data-locale') || 'es';

  // Load translations from data attribute
  const translationsAttr = container?.getAttribute('data-translations');
  let translations: any = {};
  if (translationsAttr) {
    try {
      translations = JSON.parse(translationsAttr);
    } catch (e) {
      console.error('[GiftRedemptionFlow] Failed to parse translations:', e);
    }
  }

  // State
  let currentStep = 1;
  let giftData: GiftData | null = null;
  let selectedDate: string | null = null;
  let selectedSlot: TimeSlot | null = null;
  let bookingResult: any = null;
  let currentMonth = new Date();
  let availableDates: Map<string, { date: string; hasSlots: boolean; slotCount: number }> = new Map();

  // Helper: Navigate to step
  function goToStep(step: number) {
    currentStep = step;

    // Update indicator
    document.querySelectorAll('.step').forEach((el, index) => {
      el.setAttribute('data-active', index + 1 === step ? 'true' : 'false');
    });

    // Update content
    document.querySelectorAll('.step-content').forEach((el, index) => {
      el.setAttribute('data-active', index + 1 === step ? 'true' : 'false');
    });

    // Scroll to top
    window.scrollTo({ top: 0, behavior: 'smooth' });
  }

  // Helper: Show error
  function showError(elementId: string, message: string) {
    const el = document.getElementById(elementId);
    if (el) {
      el.textContent = message;
    }
  }

  // Helper: Clear error
  function clearError(elementId: string) {
    const el = document.getElementById(elementId);
    if (el) {
      el.textContent = '';
    }
  }

  // Step 1: Validate Code
  const codeForm = document.getElementById('code-form') as HTMLFormElement;
  const validateBtn = document.getElementById('validate-btn') as HTMLButtonElement;

  codeForm?.addEventListener('submit', async (e) => {
    e.preventDefault();
    clearError('code-error');

    const input = document.getElementById('gift-code') as HTMLInputElement;
    const code = input.value.trim().toUpperCase();

    validateBtn.disabled = true;

    const result = await validateGift(code);

    if (result.valid && result.gift) {
      // Merge gift data with session info (session is at top level in API response)
      giftData = {
        ...result.gift,
        code: code,
        baseSession: result.session || { id: 0, title: '' }
      };
      renderGiftInfo();
      loadCalendar();
      goToStep(2);
    } else {
      let errorMsg = translations.errorInvalid;

      if (result.error === 'redeemed' && result.gift?.redeemedAt) {
        errorMsg = translations.errorRedeemed.replace('{date}', new Date(result.gift.redeemedAt).toLocaleDateString());
      } else if (result.error === 'expired' && result.gift?.expiresAt) {
        errorMsg = translations.errorExpired.replace('{date}', new Date(result.gift.expiresAt).toLocaleDateString());
      } else if (result.error === 'pending_delivery') {
        errorMsg = translations.errorNotDelivered;
      }

      showError('code-error', errorMsg);
    }

    validateBtn.disabled = false;
  });

  // Render gift info
  function renderGiftInfo() {
    if (!giftData) return;

    const infoEl = document.getElementById('gift-info');
    if (!infoEl) return;

    const expiryDate = new Date(giftData.expiresAt).toLocaleDateString();

    infoEl.innerHTML = `
      <div style="display: flex; justify-content: space-between; align-items: start; margin-bottom: 1rem;">
        <div>
          <div style="font-size: 0.875rem; color: #DB4529; font-weight: 600; margin-bottom: 0.5rem;">
            ${translations.validCode}
          </div>
          <div style="font-weight: 700; font-size: 1.25rem; color: #1F2937;">
            ${giftData.baseSession.title}
          </div>
        </div>
        <div style="text-align: right; font-size: 0.875rem; color: #6B7280;">
          <div>${translations.validUntil}</div>
          <div style="font-weight: 600;">${expiryDate}</div>
        </div>
      </div>
      <div style="display: flex; gap: 2rem; padding-top: 1rem; border-top: 1px solid #fed7c7;">
        <div style="font-size: 0.875rem; color: #DB4529;">
          ${translations.codeLabel}: <strong>${giftData.code}</strong>
        </div>
        <div style="font-size: 0.875rem; color: #DB4529;">
          ${translations.includedPersons.replace('{n}', String(giftData.includedPersons))}
        </div>
      </div>
    `;
  }

  // Load calendar with available dates
  async function loadCalendar() {
    if (!giftData) return;

    const calendarContainer = document.getElementById('calendar-container');
    if (!calendarContainer) return;

    calendarContainer.innerHTML = `<div class="calendar-loading">${translations.loadingDates}</div>`;

    const today = new Date();
    const startDate = today.toISOString().split('T')[0];
    const endDateObj = new Date(today);
    endDateObj.setMonth(endDateObj.getMonth() + 3);
    const endDate = endDateObj.toISOString().split('T')[0];

    try {
      const dates = await getAvailableDates({
        sessionId: giftData.baseSession.id,
        startDate,
        endDate
      });

      availableDates.clear();
      if (dates && dates.length > 0) {
        dates.forEach((d: { date: string; hasSlots: boolean; slotCount?: number }) => {
          availableDates.set(d.date, {
            date: d.date,
            hasSlots: d.hasSlots,
            slotCount: d.slotCount || 0
          });
        });
      }

      calendarContainer.innerHTML = `
        <div class="calendar-header">
          <button type="button" class="calendar-nav prev-month" aria-label="${translations.prevMonth}">
            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
              <path d="M15 18l-6-6 6-6"/>
            </svg>
          </button>
          <span class="calendar-month-year"></span>
          <button type="button" class="calendar-nav next-month" aria-label="${translations.nextMonth}">
            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
              <path d="M9 18l6-6-6-6"/>
            </svg>
          </button>
        </div>
        <div class="calendar-weekdays">
          ${translations.weekdays.map((day: string) => `<div class="weekday">${day}</div>`).join('')}
        </div>
        <div class="calendar-grid"></div>
      `;

      const prevBtn = calendarContainer.querySelector('.prev-month');
      const nextBtn = calendarContainer.querySelector('.next-month');

      prevBtn?.addEventListener('click', () => navigateMonth(-1));
      nextBtn?.addEventListener('click', () => navigateMonth(1));

      renderCalendar();

    } catch (error) {
      console.error('[GiftRedemptionFlow] Error loading available dates:', error);
      calendarContainer.innerHTML = `<div class="calendar-loading">${translations.noDates}</div>`;
    }
  }

  // Render calendar grid
  function renderCalendar() {
    const calendarContainer = document.getElementById('calendar-container');
    if (!calendarContainer) return;

    const monthYearEl = calendarContainer.querySelector('.calendar-month-year');
    if (monthYearEl) {
      const months = translations.months as string[];
      monthYearEl.textContent = `${months[currentMonth.getMonth()]} ${currentMonth.getFullYear()}`;
    }

    const firstDay = new Date(currentMonth.getFullYear(), currentMonth.getMonth(), 1);
    const lastDay = new Date(currentMonth.getFullYear(), currentMonth.getMonth() + 1, 0);
    const startOffset = (firstDay.getDay() + 6) % 7;
    const totalDays = lastDay.getDate();

    const grid = calendarContainer.querySelector('.calendar-grid');
    if (!grid) return;

    let html = '';

    for (let i = 0; i < startOffset; i++) {
      html += '<button type="button" class="calendar-day empty" disabled></button>';
    }

    const today = new Date();
    today.setHours(0, 0, 0, 0);

    const toLocalDateString = (d: Date): string => {
      const year = d.getFullYear();
      const month = String(d.getMonth() + 1).padStart(2, '0');
      const day = String(d.getDate()).padStart(2, '0');
      return `${year}-${month}-${day}`;
    };

    for (let day = 1; day <= totalDays; day++) {
      const date = new Date(currentMonth.getFullYear(), currentMonth.getMonth(), day);
      const dateStr = toLocalDateString(date);
      const isToday = date.getTime() === today.getTime();
      const isPast = date < today;
      const dateData = availableDates.get(dateStr);
      // For gifts, we need slots with enough capacity for all included persons
      const minCapacity = giftData?.includedPersons || 1;
      const isAvailable = dateData?.hasSlots === true && (dateData.slotCount || 0) >= minCapacity;
      const isSelected = dateStr === selectedDate;

      const classes = ['calendar-day'];
      if (isToday) classes.push('today');
      if (isPast) classes.push('disabled');
      else if (isAvailable) {
        classes.push('available');
      } else {
        classes.push('disabled');
      }
      if (isSelected) classes.push('selected');

      html += `
        <button
          type="button"
          class="${classes.join(' ')}"
          data-date="${dateStr}"
          ${isPast || !isAvailable ? 'disabled' : ''}
        >
          ${day}
        </button>
      `;
    }

    grid.innerHTML = html;

    grid.querySelectorAll('.calendar-day.available').forEach((dayBtn) => {
      dayBtn.addEventListener('click', async (e) => {
        const dateStr = (e.currentTarget as HTMLElement).dataset.date;
        if (dateStr) {
          selectedDate = dateStr;
          renderCalendar();
          await loadSlots(dateStr);
        }
      });
    });

    const prevBtn = calendarContainer.querySelector('.prev-month') as HTMLButtonElement;
    if (prevBtn) {
      const prevMonth = new Date(currentMonth.getFullYear(), currentMonth.getMonth() - 1);
      prevBtn.disabled = prevMonth < new Date(today.getFullYear(), today.getMonth());
    }
  }

  function navigateMonth(delta: number) {
    currentMonth = new Date(
      currentMonth.getFullYear(),
      currentMonth.getMonth() + delta,
      1
    );
    renderCalendar();
  }

  // Load time slots
  async function loadSlots(date: string) {
    if (!giftData) return;

    const slotsContainer = document.getElementById('slots-container');
    if (!slotsContainer) return;

    slotsContainer.innerHTML = '<p>Cargando horarios...</p>';
    slotsContainer.classList.remove('hidden');

    const dayData = await getDaySlots({
      sessionId: giftData.baseSession.id,
      date: date,
    });

    // Filter slots that have enough capacity for all included persons
    const minCapacity = giftData.includedPersons;
    const availableSlots = dayData?.slots.filter((slot) =>
      slot.bookable && slot.capacity.available >= minCapacity
    ) || [];

    if (!availableSlots.length) {
      showError('date-error', translations.noSlots);
      slotsContainer.classList.add('hidden');
      return;
    }

    clearError('date-error');

    const slotsHTML = availableSlots
      .map((slot) => `
        <button
          type="button"
          class="slot-btn"
          data-slot='${JSON.stringify(slot)}'
        >
          <div class="slot-time">${formatTime(slot.startTime)}</div>
          <div class="slot-capacity">${slot.capacity.available} ${translations.available}</div>
        </button>
      `)
      .join('');

    slotsContainer.innerHTML = `<div class="slots-grid">${slotsHTML}</div>`;

    document.querySelectorAll('.slot-btn').forEach((btn) => {
      btn.addEventListener('click', (e) => {
        const slotData = (e.currentTarget as HTMLElement).getAttribute('data-slot');
        if (slotData) {
          selectedSlot = JSON.parse(slotData);
          renderAttendeesForm();
          goToStep(3);
        }
      });
    });
  }

  // Render attendees form
  function renderAttendeesForm() {
    if (!giftData || !selectedDate || !selectedSlot) return;

    // Render booking summary
    const summaryEl = document.getElementById('booking-summary');
    if (summaryEl) {
      summaryEl.innerHTML = `
        <div style="background: #F9FAFB; border-radius: 8px; padding: 1rem; margin-bottom: 1.5rem;">
          <div style="font-weight: 600; margin-bottom: 0.5rem;">${giftData.baseSession.title}</div>
          <div style="font-size: 0.875rem; color: #6B7280;">
            ${formatDate(selectedDate, locale)} - ${formatTime(selectedSlot.startTime)}
          </div>
        </div>
      `;
    }

    // Update description
    const descEl = document.getElementById('attendees-description');
    if (descEl) {
      descEl.textContent = translations.attendeesDetails.replace('{n}', String(giftData.includedPersons));
    }

    // Generate attendee forms
    const listEl = document.getElementById('attendees-list');
    if (!listEl) return;

    let html = '';
    for (let i = 0; i < giftData.includedPersons; i++) {
      html += `
        <div class="attendee-card">
          <div class="attendee-header">
            <span class="attendee-number">${i + 1}</span>
            <span>${translations.attendeeLabel.replace('{n}', String(i + 1))}</span>
          </div>
          <div class="attendee-fields">
            <div class="form-group" style="margin-bottom: 0.5rem;">
              <label for="attendee-name-${i}" class="form-label">${translations.nameLabel} *</label>
              <input
                type="text"
                id="attendee-name-${i}"
                name="attendee_name_${i}"
                class="form-input attendee-name"
                required
              />
            </div>
            <div class="form-group" style="margin-bottom: 0.5rem;">
              <label for="attendee-email-${i}" class="form-label">${translations.emailLabel} *</label>
              <input
                type="email"
                id="attendee-email-${i}"
                name="attendee_email_${i}"
                class="form-input attendee-email"
                required
              />
            </div>
          </div>
        </div>
      `;
    }

    listEl.innerHTML = html;
  }

  // Back to slots button
  document.getElementById('back-to-slots')?.addEventListener('click', () => {
    goToStep(2);
  });

  // Step 3: Submit attendees form
  const attendeesForm = document.getElementById('attendees-form') as HTMLFormElement;
  const confirmBtn = document.getElementById('confirm-btn') as HTMLButtonElement;

  attendeesForm?.addEventListener('submit', async (e) => {
    e.preventDefault();
    clearError('form-error');

    if (!giftData || !selectedDate || !selectedSlot) return;

    // Collect all attendees
    const attendees: Array<{ name: string; email: string; dni?: string }> = [];
    let hasErrors = false;

    for (let i = 0; i < giftData.includedPersons; i++) {
      const nameInput = document.getElementById(`attendee-name-${i}`) as HTMLInputElement;
      const emailInput = document.getElementById(`attendee-email-${i}`) as HTMLInputElement;

      const name = nameInput?.value.trim();
      const email = emailInput?.value.trim();

      if (!name || !email) {
        hasErrors = true;
      }

      attendees.push({
        name: name || '',
        email: email || '',
      });
    }

    if (hasErrors) {
      showError('form-error', translations.allAttendeesRequired);
      return;
    }

    // Validate consents
    const privacyConsent = (document.getElementById('privacy-consent') as HTMLInputElement)?.checked;
    const termsConsent = (document.getElementById('terms-consent') as HTMLInputElement)?.checked;

    if (!privacyConsent) {
      showError('form-error', translations.privacyRequired);
      return;
    }

    if (!termsConsent) {
      showError('form-error', translations.termsRequired);
      return;
    }

    confirmBtn.disabled = true;

    const request = {
      code: giftData.code,
      slot_date: selectedDate,
      slot_time: formatTime(selectedSlot.startTime),
      attendees: attendees,
      consents: {
        privacy: privacyConsent,
        terms: termsConsent,
      },
      language: locale.toUpperCase(),
    };

    const result = await redeemGift(request);

    if (result.success) {
      bookingResult = result;
      renderConfirmation();
      goToStep(4);
    } else {
      showError('form-error', result.error || translations.errorGeneric);
    }

    confirmBtn.disabled = false;
  });

  // Render confirmation
  function renderConfirmation() {
    if (!bookingResult || !giftData || !selectedDate || !selectedSlot) return;

    const detailsEl = document.getElementById('confirmation-details');
    if (!detailsEl) return;

    detailsEl.innerHTML = `
      <div style="margin-bottom: 1rem;">
        <div style="font-size: 0.875rem; color: #6B7280; margin-bottom: 0.25rem;">${translations.bookingNumber}</div>
        <div style="font-weight: 600; font-size: 1.125rem;">${bookingResult.booking_number}</div>
      </div>
      <div style="margin-bottom: 1rem;">
        <div style="font-size: 0.875rem; color: #6B7280; margin-bottom: 0.25rem;">${translations.yourTicket}</div>
        <div style="font-weight: 600;">${giftData.baseSession.title}</div>
      </div>
      <div style="display: grid; grid-template-columns: 1fr 1fr 1fr; gap: 1rem;">
        <div>
          <div style="font-size: 0.875rem; color: #6B7280; margin-bottom: 0.25rem;">${translations.bookingDate}</div>
          <div style="font-weight: 600;">${formatDate(selectedDate, locale)}</div>
        </div>
        <div>
          <div style="font-size: 0.875rem; color: #6B7280; margin-bottom: 0.25rem;">${translations.bookingTime}</div>
          <div style="font-weight: 600;">${formatTime(selectedSlot.startTime)}</div>
        </div>
        <div>
          <div style="font-size: 0.875rem; color: #6B7280; margin-bottom: 0.25rem;">${translations.bookingAttendees}</div>
          <div style="font-weight: 600;">${giftData.includedPersons}</div>
        </div>
      </div>
    `;
  }

  // Action buttons
  document.getElementById('download-ticket')?.addEventListener('click', () => {
    if (bookingResult?.ticket_url) {
      window.open(bookingResult.ticket_url, '_blank');
    }
  });

  document.getElementById('add-calendar')?.addEventListener('click', () => {
    alert('Add to calendar feature coming soon');
  });

  document.getElementById('new-redemption')?.addEventListener('click', () => {
    window.location.reload();
  });
</script>
