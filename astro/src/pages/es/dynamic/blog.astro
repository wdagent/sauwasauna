---
/**
 * WDA-1032: Dynamic Blog Post Page (ES)
 * Catch-all fallback for blog post URLs not generated at build time
 *
 * Route: /es/dynamic/blog.html?slug=xxx
 *
 * This page is reached via .htaccess rewrite when a blog post URL
 * doesn't exist as a static page. It loads content dynamically
 * from WordPress and redirects to 404 if the slug doesn't exist.
 */
import Layout from '../../../layouts/Layout.astro';
import FooterBlack from '../../../components/layout/FooterBlack.astro';
import BlogPostSkeleton from '../../../components/core/skeletons/BlogPostSkeleton.astro';

const locale = 'es';

const i18n = {
  pageTitle: 'Cargando articulo... | SAUWA SAUNA',
  metaDescription: 'Cargando articulo del blog SAUWA.',
  notFoundTitle: 'Articulo no encontrado',
  notFoundMessage: 'El articulo que buscas no existe o ha sido eliminado.',
  backHome: 'Volver al inicio',
  backBlog: 'Volver al blog',
};
---

<Layout title={i18n.pageTitle} description={i18n.metaDescription} lang={locale} pageType="blog-post" navbar="none">
  <main class="dynamic-blog-page" data-page-type="dynamic-blog" data-locale={locale}>
    <!-- Loading state with skeleton -->
    <div data-loader-skeleton class="loader__skeleton">
      <BlogPostSkeleton showHero={true} showContent={true} />
    </div>

    <!-- Content container (populated dynamically) -->
    <div data-loader-content class="loader__content hidden"></div>

    <!-- Not found state -->
    <div data-loader-notfound class="loader__notfound hidden">
      <div class="notfound-container">
        <h1 class="notfound-title">404</h1>
        <h2 class="notfound-heading">{i18n.notFoundTitle}</h2>
        <p class="notfound-message">{i18n.notFoundMessage}</p>
        <div class="notfound-buttons">
          <a href={`/${locale}/guia-sauwa-sauna/`} class="notfound-btn notfound-btn--secondary">{i18n.backBlog}</a>
          <a href={`/${locale}/`} class="notfound-btn">{i18n.backHome}</a>
        </div>
      </div>
    </div>
  </main>

  <FooterBlack locale={locale} />
</Layout>

<script>
  import {
    blogPostSlugExists,
    fetchBlogPostBySlug,
    type Locale,
  } from '../../../lib/dynamic-content-client';

  import { renderBlogPost } from '../../../lib/dynamic-renderers';

  async function initDynamicBlog() {
    const params = new URLSearchParams(window.location.search);
    const slug = params.get('slug');
    const locale = (document.querySelector('[data-locale]')?.getAttribute('data-locale') || 'es') as Locale;
    const notFoundUrl = `/${locale}/404/`;

    const skeletonEl = document.querySelector('[data-loader-skeleton]');
    const contentEl = document.querySelector('[data-loader-content]');
    const notFoundEl = document.querySelector('[data-loader-notfound]');

    if (!slug) {
      console.error('[DynamicBlog] No slug provided in URL');
      window.location.href = notFoundUrl;
      return;
    }

    try {
      // Validate slug exists
      const exists = await blogPostSlugExists(slug);

      if (!exists) {
        console.warn('[DynamicBlog] Slug not found:', slug);
        skeletonEl?.classList.add('hidden');
        notFoundEl?.classList.remove('hidden');
        setTimeout(() => {
          window.location.href = notFoundUrl;
        }, 3000);
        return;
      }

      // Fetch the blog post
      const result = await fetchBlogPostBySlug(slug);

      if (result.data && contentEl) {
        skeletonEl?.classList.add('hidden');
        contentEl.classList.remove('hidden');
        renderBlogPost(contentEl, result.data, locale);

        // Update URL to clean version
        const cleanUrl = `/${locale}/guia-sauwa-sauna/${slug}/`;
        if (window.history && window.history.replaceState) {
          window.history.replaceState({ slug }, '', cleanUrl);
        }
      } else {
        throw new Error('No data returned');
      }
    } catch (error) {
      console.error('[DynamicBlog] Error loading content:', error);
      skeletonEl?.classList.add('hidden');
      notFoundEl?.classList.remove('hidden');
    }
  }

  // Initialize on DOM ready
  if (document.readyState === 'loading') {
    document.addEventListener('DOMContentLoaded', initDynamicBlog);
  } else {
    initDynamicBlog();
  }

  // Handle Astro page transitions
  document.addEventListener('astro:page-load', initDynamicBlog);
</script>

<style>
  .dynamic-blog-page {
    min-height: 100vh;
  }

  .loader__skeleton {
    transition: opacity 0.2s ease-out;
  }

  .loader__skeleton.hidden,
  .loader__content.hidden,
  .loader__notfound.hidden {
    display: none;
  }

  .loader__content {
    transition: opacity 0.2s ease-in;
  }

  .notfound-container {
    display: flex;
    flex-direction: column;
    align-items: center;
    justify-content: center;
    min-height: 70vh;
    padding: 2rem;
    text-align: center;
  }

  .notfound-title {
    font-family: var(--font-family-secondary, 'Nunito Sans', system-ui);
    font-size: 8rem;
    font-weight: 200;
    color: var(--color-primary, #DB4529);
    margin: 0;
    line-height: 1;
  }

  .notfound-heading {
    font-family: var(--font-family-secondary, 'Nunito Sans', system-ui);
    font-size: 2rem;
    font-weight: 300;
    color: var(--color-text-primary, #1a1a1a);
    margin: 1rem 0 0.5rem;
  }

  .notfound-message {
    font-family: var(--font-family-primary, 'Inter', system-ui);
    font-size: 1.125rem;
    color: var(--color-text-secondary, #6b7280);
    margin: 0 0 2rem;
    max-width: 400px;
  }

  .notfound-buttons {
    display: flex;
    gap: 1rem;
    flex-wrap: wrap;
    justify-content: center;
  }

  .notfound-btn {
    display: inline-flex;
    align-items: center;
    justify-content: center;
    padding: 0.875rem 2rem;
    font-family: var(--font-family-primary, 'Inter', system-ui);
    font-size: 0.875rem;
    font-weight: 600;
    text-transform: uppercase;
    letter-spacing: 0.05em;
    color: #ffffff;
    background: var(--color-primary, #DB4529);
    border: none;
    border-radius: 4px;
    text-decoration: none;
    transition: background-color 0.2s ease;
  }

  .notfound-btn:hover {
    background: var(--color-primary-hover, #BA2515);
  }

  .notfound-btn--secondary {
    background: transparent;
    color: var(--color-primary, #DB4529);
    border: 2px solid var(--color-primary, #DB4529);
  }

  .notfound-btn--secondary:hover {
    background: var(--color-primary, #DB4529);
    color: #ffffff;
  }

  @media (max-width: 767px) {
    .notfound-title {
      font-size: 5rem;
    }

    .notfound-heading {
      font-size: 1.5rem;
    }

    .notfound-message {
      font-size: 1rem;
    }
  }
</style>
